---
import { getCollection } from "astro:content";
import BaseLayout from "../layouts/BaseLayout.astro";
import { SITE_INFO } from "../consts";
import "../styles/moments.css";

const allMoments = await getCollection("moments");
const sortedMoments = allMoments.sort((a, b) =>
    b.data.date.localeCompare(a.data.date),
);

const pageMeta = {
    title: "动态",
    desc: "以碎片化的记录汇聚时光的川流",
};

type ImgItem = { url: string; alt: string };

function getImgLayout(imgs: ImgItem[]): "single" | "grid2" | "grid3" | "overflow" {
    const n = imgs.length;
    if (n === 1) return "single";
    if (n <= 4) return "grid2";
    if (n <= 9) return "grid3";
    return "overflow";
}
---

<BaseLayout pageTitle={pageMeta.title} pageDescription={pageMeta.desc}>
    <article class="article-container doc">
        <article class="moments">
            <h1 id="动态">动态</h1>
            
            {sortedMoments.map((moment) => {
                const { date, para, imgs, loc, stars, comments } = moment.data;

                return (
                    <div class="moment-item">
                        {/* 头部：日期 */}
                        <h2 id={date.split('.').join('')}>{date}</h2>

                        {/* 正文 */}
                        {para && para.map((text) => (
                            <p class="moment-text">{text}</p>
                        ))}

                        {/* 图片 */}
                        {imgs && imgs.length > 0 && (
                            <>
                                {/* 1张：单图 */}
                                {getImgLayout(imgs) === "single" && (
                                    <div class="img-single">
                                        <img src={imgs[0].url} alt={imgs[0].alt} loading="lazy" decoding="async" />
                                    </div>
                                )}
                                {/* 2~4张：四宫格 */}
                                {getImgLayout(imgs) === "grid2" && (
                                    <div class="img-grid-2x2">
                                        {imgs.map((img) => (
                                            <img src={img.url} alt={img.alt} loading="lazy" decoding="async" />
                                        ))}
                                    </div>
                                )}
                                {/* 5~9张：九宫格 */}
                                {getImgLayout(imgs) === "grid3" && (
                                    <div class="img-grid-3x3">
                                        {imgs.map((img) => (
                                            <img src={img.url} alt={img.alt} loading="lazy" decoding="async" />
                                        ))}
                                    </div>
                                )}
                                {/* >9张：九宫格 + 第9格朦胧遮罩 */}
                                {getImgLayout(imgs) === "overflow" && (
                                    <div class="img-grid-3x3">
                                        {imgs.slice(0, 8).map((img) => (
                                            <img src={img.url} alt={img.alt} loading="lazy" decoding="async" />
                                        ))}
                                        <div class="img-mask-overlay" style={`background-image: url('${imgs[8].url}')`}>
                                            <span class="img-mask-count">+{imgs.length - 8}</span>
                                        </div>
                                    </div>
                                )}
                            </>
                        )}

                        {/* 地理位置 */}
                        {loc && <p class="location"><code>{loc}</code></p>}

                        {/* 互动区域：点赞和评论 */}
                        {(stars || comments) && (
                            <blockquote class="interaction-area">
                                {stars && (
                                    <div class="stars-box">
                                        <code>{stars.join(", ")}</code>
                                    </div>
                                )}
                                
                                {comments && (
                                    <div class="comments-box">
                                        {comments.map((comment) => (
                                            <div class="comment-line">
                                                <span class="comment-user">睿屿青衫:</span>
                                                <span class="comment-content">{comment}</span>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </blockquote>
                        )}
                    </div>
                );
            })}
            
            {/* 备案信息 */}
            <footer class="moments-footer">
                <p class="end-tip">{SITE_INFO.endTip}</p>
                {SITE_INFO.icpNo && (
                    <p class="icp-info">
                        {SITE_INFO.icpLink ? (
                            <a href={SITE_INFO.icpLink} target="_blank" rel="noopener noreferrer">
                                {SITE_INFO.icpNo}
                            </a>
                        ) : (
                            <span>{SITE_INFO.icpNo}</span>
                        )}
                    </p>
                )}
            </footer>
        </article>
    </article>
</BaseLayout>